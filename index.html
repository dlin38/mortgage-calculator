<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Mortgage Prepayment Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè†</text></svg>">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .camera-input {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white py-8 shadow-lg">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold mb-2 flex items-center gap-3">
                    <span>üè†</span>
                    <span>Smart Mortgage Calculator</span>
                </h1>
                <p class="text-purple-100">Upload your statement or enter details manually</p>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Upload Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üìÑ Upload Mortgage Statement (Optional)</h2>
                <p class="text-gray-600 mb-4">Take a photo or upload a PDF/image of your latest statement. We'll extract the details automatically.</p>
                
                <div class="flex flex-wrap gap-3 mb-4">
                    <label for="file-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2">
                        <span>üìÅ</span>
                        <span>Choose File</span>
                    </label>
                    <input id="file-upload" type="file" accept="image/*,application/pdf" class="hidden" onchange="handleFileUpload(event)">
                    
                    <label for="camera-upload" class="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2">
                        <span>üì∑</span>
                        <span>Take Photo</span>
                    </label>
                    <input id="camera-upload" type="file" accept="image/*" capture="environment" class="hidden" onchange="handleFileUpload(event)">
                </div>
                
                <div id="upload-status" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
                        <div class="loading-spinner mt-1"></div>
                        <div>
                            <p class="font-semibold text-blue-800">Processing statement...</p>
                            <p class="text-sm text-blue-600" id="ocr-progress">Extracting text from image...</p>
                        </div>
                    </div>
                </div>
                
                <div id="extracted-preview" class="hidden mt-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="font-semibold text-green-800 mb-2">‚úì Statement processed!</p>
                        <div class="text-sm text-green-700" id="extracted-text"></div>
                    </div>
                </div>
            </div>

            <!-- Manual Input Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üìä Mortgage Details</h2>
                
                <div class="space-y-6">
                    <!-- Basic Info Section -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">üìã Basic Information</h4>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Principal Balance *</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                                    <input type="number" id="principal" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="244553" value="">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Interest Rate *</label>
                                <div class="relative">
                                    <input type="number" step="0.01" id="rate" class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="3.875" value="">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Remaining Term (Years)
                                    <span class="text-xs text-gray-500">(or fill payment breakdown)</span>
                                </label>
                                <input type="number" id="years" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="15" value="">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Original Term (Years)
                                    <span class="text-xs text-gray-500">(optional)</span>
                                </label>
                                <input type="number" id="original-years" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="30" value="">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Escrow</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                                    <input type="number" id="escrow" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="5685" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Payment Breakdown Section -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">üí∞ This Month's Payment Breakdown (Optional)</h4>
                        <p class="text-sm text-gray-600 mb-3">Enter from your statement to auto-detect extra payments and calculate remaining term</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Principal Payment</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                                    <input type="number" step="0.01" id="current-principal" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="1572.85" value="">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Interest Payment</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                                    <input type="number" step="0.01" id="current-interest" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="794.78" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Extra Payments Section -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">üöÄ Extra Payments</h4>
                        <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Extra Monthly Payment</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-500">$</span>
                            <input type="number" id="extra" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0" value="0" onchange="clearRoundUp()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Round Up Payment To
                            <span class="text-xs text-gray-500">(alternative)</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-500">$</span>
                            <input type="number" id="roundup" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="e.g. 4000" value="" onchange="calculateExtraFromRoundUp()">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Calculator will determine extra payment needed</p>
                    </div>
                    
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">One-Time Extra Payment</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                                    <input type="number" id="lumpsum" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="calculateMortgage()" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white py-3 rounded-lg font-semibold text-lg transition shadow-lg">
                    Calculate Prepayment Schedule üöÄ
                </button>
            </div>

            <!-- Results Section -->
            <div id="results" class="hidden">
                <!-- Loan Progress (if calculated from statement) -->
                <div id="loan-progress" class="hidden bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üéØ</span>
                        <span>Loan Progress</span>
                    </h3>
                    <div class="grid md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm opacity-90 mb-1">Original Loan Amount</div>
                            <div class="text-2xl font-bold" id="original-amount">--</div>
                        </div>
                        <div>
                            <div class="text-sm opacity-90 mb-1">Original Term</div>
                            <div class="text-2xl font-bold" id="original-term">--</div>
                        </div>
                        <div>
                            <div class="text-sm opacity-90 mb-1">Payments Made</div>
                            <div class="text-2xl font-bold" id="payments-made">--</div>
                        </div>
                        <div>
                            <div class="text-sm opacity-90 mb-1">Principal Paid Down</div>
                            <div class="text-2xl font-bold" id="principal-paid">--</div>
                        </div>
                    </div>
                    <div class="mt-4 bg-white bg-opacity-20 rounded p-3 text-sm">
                        üí° Based on your current payment breakdown, we reverse-engineered your original loan details!
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-6">
                        <div class="text-sm opacity-90 mb-1">New Payoff Date</div>
                        <div class="text-3xl font-bold" id="payoff-date">--</div>
                        <div class="text-sm opacity-90 mt-2" id="time-saved">--</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-6">
                        <div class="text-sm opacity-90 mb-1">Interest Saved</div>
                        <div class="text-3xl font-bold" id="interest-saved">--</div>
                        <div class="text-sm opacity-90 mt-2">vs. standard payment</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg shadow-lg p-6">
                        <div class="text-sm opacity-90 mb-1">Total Paid</div>
                        <div class="text-3xl font-bold" id="total-paid">--</div>
                        <div class="text-sm opacity-90 mt-2">Principal + Interest</div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">üìà Balance Over Time</h3>
                    <div style="max-height: 400px;">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>

                <!-- Detailed Schedule -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üìÖ Prepayment Schedule</h3>
                        <div class="flex gap-2">
                            <select id="schedule-view" onchange="renderScheduleTable()" class="bg-gray-100 border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="12">First Year</option>
                                <option value="24">First 2 Years</option>
                                <option value="60">First 5 Years</option>
                                <option value="all">All Months</option>
                            </select>
                            <button onclick="exportToCSV()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm font-medium">
                                üì• Export CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 border-b-2 border-gray-300">
                                <tr class="text-left">
                                    <th class="py-2 px-3">Month</th>
                                    <th class="py-2 px-3">Date</th>
                                    <th class="py-2 px-3">Payment</th>
                                    <th class="py-2 px-3">Principal</th>
                                    <th class="py-2 px-3">Interest</th>
                                    <th class="py-2 px-3">Extra</th>
                                    <th class="py-2 px-3">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table" class="divide-y divide-gray-200">
                                <!-- Rows inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="schedule-info" class="text-sm text-gray-600 mt-3 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üè† Mortgage Calculator loaded');
        console.log('Tesseract available:', typeof Tesseract !== 'undefined');
        console.log('Chart.js available:', typeof Chart !== 'undefined');
        
        let scheduleData = [];
        let chart = null;
        
        function calculateExtraFromRoundUp() {
            const roundUpAmount = parseFloat(document.getElementById('roundup').value);
            if (!roundUpAmount) return;
            
            const principal = parseFloat(document.getElementById('principal').value);
            const rate = parseFloat(document.getElementById('rate').value) / 100 / 12;
            const years = parseFloat(document.getElementById('years').value);
            const escrow = parseFloat(document.getElementById('escrow').value) || 0;
            
            if (!principal || !rate) {
                alert('Please fill in principal balance and interest rate first.');
                return;
            }
            
            // Calculate standard payment
            // If we have years, use it; otherwise calculate from payment breakdown
            let standardPayment;
            if (years) {
                const months = years * 12;
                standardPayment = principal * (rate * Math.pow(1 + rate, months)) / (Math.pow(1 + rate, months) - 1);
            } else {
                // Try to get from current payment breakdown
                const currentPrincipal = parseFloat(document.getElementById('current-principal').value);
                const currentInterest = parseFloat(document.getElementById('current-interest').value);
                if (currentPrincipal && currentInterest) {
                    standardPayment = currentPrincipal + currentInterest;
                    // Remove any existing extra from current principal
                    const expectedInterest = principal * rate;
                    standardPayment = (currentPrincipal + currentInterest) - (currentPrincipal - (standardPayment - expectedInterest));
                } else {
                    alert('Please fill in remaining term or current payment breakdown first.');
                    return;
                }
            }
            
            const totalStandardPayment = standardPayment + escrow;
            
            // Calculate extra
            const extra = roundUpAmount - totalStandardPayment;
            
            console.log('Round-up calculation:', {
                roundUpAmount,
                standardPayment: standardPayment.toFixed(2),
                escrow: escrow.toFixed(2),
                totalStandard: totalStandardPayment.toFixed(2),
                extra: extra.toFixed(2)
            });
            
            if (extra < 0) {
                alert(`Round-up amount ($${roundUpAmount.toLocaleString()}) is less than standard payment ($${totalStandardPayment.toFixed(2)})`);
                document.getElementById('roundup').value = '';
                return;
            }
            
            document.getElementById('extra').value = Math.round(extra);
            
            // Show feedback
            document.getElementById('roundup').classList.add('bg-green-50', 'border-green-300');
            setTimeout(() => {
                document.getElementById('roundup').classList.remove('bg-green-50', 'border-green-300');
            }, 1000);
        }
        
        function clearRoundUp() {
            document.getElementById('roundup').value = '';
        }
        
        function calculateRemainingTerm(balance, monthlyRate, monthlyPayment) {
            // Calculate remaining months using amortization formula
            // n = -ln(1 - (B * r / P)) / ln(1 + r)
            // Where: B = balance, r = monthly rate, P = payment
            
            if (balance <= 0 || monthlyRate <= 0 || monthlyPayment <= 0) return null;
            
            // Check if payment is sufficient to pay off loan
            const minPayment = balance * monthlyRate;
            if (monthlyPayment <= minPayment) {
                // Payment doesn't even cover interest - infinite loan
                return null;
            }
            
            try {
                const numerator = Math.log(1 - (balance * monthlyRate / monthlyPayment));
                const denominator = Math.log(1 + monthlyRate);
                const months = -numerator / denominator;
                
                // Sanity check: between 1 month and 40 years
                if (months > 0 && months <= 480) {
                    return Math.round(months);
                }
            } catch (e) {
                console.error('Error calculating term:', e);
            }
            
            return null;
        }
        
        function calculateLoanProgress(currentBalance, monthlyRate, standardPayment, remainingMonths) {
            // Work backwards to find original loan details
            // Try common loan terms: 30, 20, 15 years
            
            console.log('=== Calculating Loan Progress ===');
            console.log('Current balance:', currentBalance);
            console.log('Monthly rate:', monthlyRate);
            console.log('Standard payment:', standardPayment);
            console.log('Remaining months:', remainingMonths);
            
            const commonTerms = [360, 240, 180]; // 30, 20, 15 years in months
            let bestMatch = null;
            
            for (const originalTerm of commonTerms) {
                // Calculate what the original loan amount would be for this term
                // Using: P = L √ó [r(1+r)^n] / [(1+r)^n - 1]
                // Solve for L: L = P √ó [(1+r)^n - 1] / [r(1+r)^n]
                
                const factor = Math.pow(1 + monthlyRate, originalTerm);
                const originalAmount = standardPayment * (factor - 1) / (monthlyRate * factor);
                
                // Calculate how many payments have been made
                const paymentsMade = originalTerm - remainingMonths;
                
                // Calculate principal paid down
                const principalPaid = originalAmount - currentBalance;
                
                console.log(`\nTrying ${originalTerm / 12}-year term:`);
                console.log('  Original amount:', Math.round(originalAmount));
                console.log('  Payments made:', Math.round(paymentsMade));
                console.log('  Principal paid:', Math.round(principalPaid));
                
                // Sanity check: payments made should be positive and reasonable
                if (paymentsMade > 0 && paymentsMade < originalTerm && principalPaid > 0) {
                    // This could be the original term
                    // Prefer the term that results in a positive, reasonable number of payments made
                    if (!bestMatch || Math.abs(paymentsMade - originalTerm / 2) < Math.abs(bestMatch.paymentsMade - bestMatch.originalTerm / 2)) {
                        bestMatch = {
                            originalAmount: Math.round(originalAmount),
                            originalTerm: Math.round(originalTerm / 12), // Convert to years
                            paymentsMade: Math.round(paymentsMade),
                            principalPaid: Math.round(principalPaid),
                            percentComplete: Math.round((paymentsMade / originalTerm) * 100)
                        };
                    }
                }
            }
            
            console.log('\n‚úì Best match:', bestMatch);
            return bestMatch;
        }

        async function handleFileUpload(event) {
            console.log('=== FILE UPLOAD STARTED ===');
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('File:', file.name, file.type, file.size, 'bytes');
            
            document.getElementById('upload-status').classList.remove('hidden');
            document.getElementById('extracted-preview').classList.add('hidden');
            
            try {
                let text = '';
                
                if (file.type === 'application/pdf') {
                    console.log('PDF detected - not supported yet');
                    // For PDF, we'd need pdf.js - for now, prompt user to use image
                    alert('PDF support coming soon! Please take a photo of your statement instead.');
                    document.getElementById('upload-status').classList.add('hidden');
                    return;
                }
                
                console.log('Starting OCR...');
                
                // OCR for images
                document.getElementById('ocr-progress').textContent = 'Reading statement...';
                
                try {
                    const result = await Tesseract.recognize(file, 'eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                document.getElementById('ocr-progress').textContent = 
                                    `Processing: ${Math.round(m.progress * 100)}%`;
                            }
                        }
                    });
                    
                    text = result.data.text;
                    console.log('OCR Text:', text); // Debug output
                    
                    if (!text || text.trim().length < 50) {
                        throw new Error('OCR returned insufficient text');
                    }
                } catch (ocrError) {
                    console.error('OCR Error:', ocrError);
                    throw new Error('Failed to extract text from image. Please ensure image is clear and well-lit.');
                }
                
                // Parse the text
                const parsed = parseStatement(text);
                
                // Calculate remaining term and detect extra payments
                let calculatedTerm = null;
                let detectedExtraPayment = 0;
                let loanProgress = null;
                
                if (parsed.principal && parsed.rate && parsed.currentPrincipalPayment && parsed.currentInterestPayment) {
                    const monthlyRate = parsed.rate / 100 / 12;
                    const totalPayment = parsed.currentPrincipalPayment + parsed.currentInterestPayment;
                    
                    // First, calculate what the STANDARD principal payment should be
                    // Standard = Total Payment - Interest
                    // Where Interest = Balance √ó Monthly Rate
                    const expectedInterest = parsed.principal * monthlyRate;
                    const standardPrincipal = totalPayment - expectedInterest;
                    
                    // Detect extra payment
                    if (parsed.currentPrincipalPayment > standardPrincipal + 50) {
                        // There's an extra payment (allow $50 buffer for rounding)
                        detectedExtraPayment = Math.round(parsed.currentPrincipalPayment - standardPrincipal);
                    }
                    
                    // Calculate remaining term using STANDARD payment (without extra)
                    const standardPayment = totalPayment - detectedExtraPayment;
                    calculatedTerm = calculateRemainingTerm(
                        parsed.principal,
                        monthlyRate,
                        standardPayment
                    );
                    
                    // Calculate original loan details using standard payment
                    loanProgress = calculateLoanProgress(
                        parsed.principal,
                        monthlyRate,
                        standardPayment,
                        calculatedTerm
                    );
                }
                
                if (parsed.principal) document.getElementById('principal').value = parsed.principal;
                if (parsed.rate) document.getElementById('rate').value = parsed.rate;
                if (calculatedTerm) document.getElementById('years').value = (calculatedTerm / 12).toFixed(1);
                if (parsed.escrow) document.getElementById('escrow').value = parsed.escrow;
                if (detectedExtraPayment > 0) document.getElementById('extra').value = detectedExtraPayment;
                
                // Fill in current payment breakdown fields
                if (parsed.currentPrincipalPayment) document.getElementById('current-principal').value = parsed.currentPrincipalPayment.toFixed(2);
                if (parsed.currentInterestPayment) document.getElementById('current-interest').value = parsed.currentInterestPayment.toFixed(2);
                
                // Auto-fill original term if we calculated loan progress
                if (loanProgress) {
                    document.getElementById('original-years').value = loanProgress.originalTerm;
                }
                
                document.getElementById('upload-status').classList.add('hidden');
                document.getElementById('extracted-preview').classList.remove('hidden');
                
                // Show loan progress if calculated
                if (loanProgress) {
                    document.getElementById('loan-progress').classList.remove('hidden');
                    document.getElementById('original-amount').textContent = '$' + loanProgress.originalAmount.toLocaleString();
                    document.getElementById('original-term').textContent = loanProgress.originalTerm + ' years';
                    document.getElementById('payments-made').textContent = loanProgress.paymentsMade + ' months';
                    document.getElementById('principal-paid').textContent = '$' + loanProgress.principalPaid.toLocaleString();
                }
                
                let extractedInfo = '';
                
                // Check if any data was extracted
                const hasData = parsed.principal || parsed.rate || parsed.escrow || 
                               parsed.currentPrincipalPayment || parsed.currentInterestPayment;
                
                if (!hasData) {
                    // No data extracted - show warning and raw text for debugging
                    extractedInfo = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-3">
                            <p class="font-semibold text-yellow-800">‚ö†Ô∏è Could not extract mortgage details</p>
                            <p class="text-sm text-yellow-700 mt-1">Please enter values manually below or try retaking the photo with better lighting.</p>
                        </div>
                        <details class="text-xs">
                            <summary class="cursor-pointer text-blue-600 hover:text-blue-700">Show extracted text (debug)</summary>
                            <pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-40">${text.substring(0, 500)}</pre>
                        </details>
                    `;
                } else {
                    extractedInfo = `<div class="grid grid-cols-2 gap-2">`;
                    if (parsed.principal) extractedInfo += `<div><strong>Principal Balance:</strong> $${parsed.principal.toLocaleString()}</div>`;
                    if (parsed.rate) extractedInfo += `<div><strong>Interest Rate:</strong> ${parsed.rate}%</div>`;
                    if (calculatedTerm) extractedInfo += `<div><strong>Remaining Term:</strong> ${(calculatedTerm / 12).toFixed(1)} years</div>`;
                    if (parsed.escrow) extractedInfo += `<div><strong>Escrow:</strong> $${parsed.escrow.toLocaleString()}</div>`;
                    if (parsed.currentPrincipalPayment) extractedInfo += `<div><strong>This Month Principal:</strong> $${parsed.currentPrincipalPayment.toLocaleString()}</div>`;
                    if (parsed.currentInterestPayment) extractedInfo += `<div><strong>This Month Interest:</strong> $${parsed.currentInterestPayment.toLocaleString()}</div>`;
                    if (detectedExtraPayment > 0) extractedInfo += `<div class="col-span-2 text-green-600 font-semibold"><strong>‚úì Extra Payment Detected:</strong> $${detectedExtraPayment.toLocaleString()}/month</div>`;
                    extractedInfo += `</div>`;
                    extractedInfo += `<p class="mt-2 text-xs">Review and adjust the values below if needed.</p>`;
                }
                
                document.getElementById('extracted-text').innerHTML = extractedInfo;
                
            } catch (error) {
                console.error('=== ERROR IN handleFileUpload ===');
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Full error:', error);
                alert('Failed to read statement. Please enter details manually. Check console for details.');
                document.getElementById('upload-status').classList.add('hidden');
            }
            
            console.log('=== FILE UPLOAD COMPLETE ===');
        }

        function parseStatement(text) {
            const parsed = {};
            
            // Keep original text for comma-aware parsing
            const originalText = text;
            
            // Clean up common OCR errors
            text = text
                .replace(/[|]/g, 'I')  // Vertical bar to I
                .replace(/[¬¢]/g, 'c')  // Cent sign
                .replace(/\s+/g, ' ')  // Multiple spaces to single
                // Fix mangled dollar amounts (common OCR errors)
                .replace(/[sS]am([0-9])/g, '\$24$1')  // "sam2es7" ‚Üí "$242..."
                .replace(/[sS]([0-9]{3})\)/g, '\$$1')  // "S259)" ‚Üí "$259"
                .replace(/[sS]([0-9]{5,7})/g, '\$$1')  // "s513430" ‚Üí "$513430"
                .replace(/[eE][sS]([0-9])/g, '$1')  // "es7" ‚Üí "7"
                .trim();
            
            console.log('Cleaned text sample:', text.substring(0, 500));
            
            // Try to find principal balance (with commas)
            // Add more flexible patterns and handle OCR errors (0/O confusion, etc)
            const principalPatterns = [
                /outstanding\s+princip[ae]l?\s+[a-z]*\s*\$?\s*([\d,]+\.?\d*)/i,  // "Principe Blancs"
                /principal\s+balance[:\s]+\$?\s*([\d,]+\.?\d*)/i,
                /unpaid\s+principal\s+balance[:\s]+\$?\s*([\d,]+\.?\d*)/i,
                /current\s+principal[:\s]+\$?\s*([\d,]+\.?\d*)/i,
                /loan\s+balance[:\s]+\$?\s*([\d,]+\.?\d*)/i,
                /remaining\s+balance[:\s]+\$?\s*([\d,]+\.?\d*)/i,
                /balance[:\s]+\$?\s*([\d,]+\.?\d{2})/i  // Generic fallback with 2 decimals
            ];
            for (const pattern of principalPatterns) {
                const match = originalText.match(pattern);
                if (match) {
                    const value = parseFloat(match[1].replace(/,/g, ''));
                    // Sanity check: principal should be > $10,000
                    if (value > 10000) {
                        parsed.principal = Math.round(value);
                        console.log(`Found principal: $${value} using pattern: ${pattern}`);
                        break;
                    }
                }
            }
            
            // Fallback 1: Look in "ACCOUNT INFORMATION" section for largest amount
            if (!parsed.principal) {
                const accountInfoMatch = originalText.match(/ACCOUNT INFORMATION[\s\S]{0,500}?(\$[\d,]+\.?\d{0,2})/i);
                if (accountInfoMatch) {
                    const value = parseFloat(accountInfoMatch[1].replace(/[$,]/g, ''));
                    if (value > 10000 && value < 1000000) {
                        parsed.principal = Math.round(value);
                        console.log(`Found principal (account info section): $${value}`);
                    }
                }
            }
            
            // Fallback 2: Look for largest dollar amount (likely the principal)
            // Principal should be significantly larger than escrow/payments
            if (!parsed.principal) {
                const allDollarAmounts = originalText.match(/\$\s*([\d,]+\.?\d{0,2})/g);
                console.log('All dollar amounts found:', allDollarAmounts ? allDollarAmounts.slice(0, 20) : 'none');
                
                if (allDollarAmounts) {
                    const amounts = allDollarAmounts
                        .map(a => parseFloat(a.replace(/[$,\s]/g, '')))
                        .filter(a => a > 50000 && a < 1000000);  // Principal should be > $50k
                    
                    console.log(`Found ${amounts.length} amounts over $50k:`, amounts);
                    
                    if (amounts.length > 0) {
                        parsed.principal = Math.round(Math.max(...amounts));
                        console.log(`Found principal (largest amount > $50k fallback): $${parsed.principal}`);
                    } else {
                        // Try lower threshold
                        const lowerAmounts = allDollarAmounts
                            .map(a => parseFloat(a.replace(/[$,\s]/g, '')))
                            .filter(a => a > 100000 && a < 1000000);
                        if (lowerAmounts.length > 0) {
                            parsed.principal = Math.round(Math.max(...lowerAmounts));
                            console.log(`Found principal (largest amount > $100k fallback): $${parsed.principal}`);
                        }
                    }
                }
            }
            
            // Try to find interest rate
            const ratePatterns = [
                /interest\s+rate[:\s]+([\d.]+)%?/i,
                /rate[:\s]+([\d.]+)%/i,
                /annual\s+(?:percentage\s+)?rate[:\s]+([\d.]+)%?/i,
                /([\d.]+)%\s+(?:interest|APR)/i
            ];
            for (const pattern of ratePatterns) {
                const match = originalText.match(pattern);
                if (match) {
                    const value = parseFloat(match[1]);
                    // Sanity check: rate should be between 0.1% and 20%
                    if (value > 0.1 && value < 20) {
                        parsed.rate = value;
                        console.log(`Found rate: ${value}% using pattern: ${pattern}`);
                        break;
                    }
                }
            }
            
            // Fallback: Look for any number followed by % in reasonable range
            if (!parsed.rate) {
                const percentages = originalText.match(/([\d.]+)\s*%/g);
                if (percentages) {
                    for (const p of percentages) {
                        const value = parseFloat(p.replace('%', '').trim());
                        if (value > 0.1 && value < 20) {
                            parsed.rate = value;
                            console.log(`Found rate (fallback): ${value}%`);
                            break;
                        }
                    }
                }
            }
            
            // Try to find escrow (taxes + insurance)
            const escrowPatterns = [
                /escrow\s+[a-z]*ance[:\s]+\$?([\d,]+\.?\d*)/i,  // "Bajance" OCR typo
                /escrow\s+balance[:\s]+\$?([\d,]+\.?\d*)/i,
                /escrow\s+\(taxes\s*\&?\s*insurance\)[:\s]+\$?([\d,]+\.?\d*)/i,
                /escrow[:\s]+\$?([\d,]+\.?\d*)/i,
                /tax\s*(?:es)?\s*\&\s*insurance[:\s]+\$?([\d,]+\.?\d*)/i,
                /impound[:\s]+\$?([\d,]+\.?\d*)/i
            ];
            for (const pattern of escrowPatterns) {
                const match = originalText.match(pattern);
                if (match) {
                    const value = parseFloat(match[1].replace(/,/g, ''));
                    // Sanity check: escrow typically < $10,000/month (increased for flexibility)
                    if (value > 0 && value < 10000) {
                        parsed.escrow = Math.round(value);
                        console.log(`Found escrow: $${value} using pattern: ${pattern}`);
                        break;
                    }
                }
            }
            
            // Fallback: Look for "Escrow Balance" followed by any $ amount
            if (!parsed.escrow) {
                const escrowMatch = originalText.match(/escrow\s+balance[:\s]+\$\s*([\d,]+\.?\d*)/i);
                if (escrowMatch) {
                    const value = parseFloat(escrowMatch[1].replace(/,/g, ''));
                    if (value > 0 && value < 10000) {
                        parsed.escrow = Math.round(value);
                        console.log(`Found escrow (fallback): $${value}`);
                    }
                }
            }
            
            // Try to detect current payment breakdown from recent transaction
            // Look in TRANSACTION ACTIVITY or similar sections for most recent payment
            const lines = originalText.split('\n');
            
            // Strategy 1: Look for transaction activity table (most accurate)
            // Pattern: MORTGAGE PAYMENT [dates] [amounts...] Principal Interest Escrow
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (/mortgage\s+payment/i.test(line) || /payment\s+posted/i.test(line)) {
                    // Extract all numbers from this line and next few lines
                    const combinedText = lines.slice(i, Math.min(i + 3, lines.length)).join(' ');
                    const numbers = combinedText.match(/\$?\s*([\d,]+\.[\d]{2})/g);
                    
                    if (numbers && numbers.length >= 2) {
                        // Try to find principal and interest
                        // Look for two consecutive numbers in $500-$5000 range
                        for (let j = 0; j < numbers.length - 1; j++) {
                            const principal = parseFloat(numbers[j].replace(/[$,\s]/g, ''));
                            const interest = parseFloat(numbers[j + 1].replace(/[$,\s]/g, ''));
                            
                            // Sanity check: both should be in typical payment range
                            if (principal > 100 && interest > 50 && 
                                principal < 10000 && interest < 10000 &&
                                principal > interest * 0.3) {
                                parsed.currentPrincipalPayment = principal;
                                parsed.currentInterestPayment = interest;
                                console.log(`Found payments - Principal: $${principal}, Interest: $${interest}`);
                                break;
                            }
                        }
                        if (parsed.currentPrincipalPayment) break;
                    }
                }
            }
            
            // Strategy 2: Look for labeled breakdown (fallback)
            // Handle OCR typos like "Prncoat" "Irtorost" "Propel" "Pencial"
            if (!parsed.currentPrincipalPayment) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // More flexible patterns for mangled OCR
                    const principalMatch = line.match(/(?:principal|prncoat|propel|pencial)[:\s]+\$?([\d,]+\.?\d*)/i);
                    const interestMatch = line.match(/(?:interest|irtorost)[:\s]+\$?([\d,]+\.?\d*)/i);
                    
                    if (principalMatch && interestMatch) {
                        const principalPayment = parseFloat(principalMatch[1].replace(/,/g, ''));
                        const interestPayment = parseFloat(interestMatch[1].replace(/,/g, ''));
                        
                        if (principalPayment > 0 && interestPayment > 0 && 
                            principalPayment < 10000 && interestPayment < 10000) {
                            parsed.currentPrincipalPayment = principalPayment;
                            parsed.currentInterestPayment = interestPayment;
                            console.log(`Found payments (labeled) - Principal: $${principalPayment}, Interest: $${interestPayment}`);
                            break;
                        }
                    }
                    
                    // Also check for "EXPLANATION OF AMOUNT DUE" section
                    if (/explanation\s+of\s+amount/i.test(line)) {
                        // Look in next few lines
                        const sectionText = lines.slice(i, Math.min(i + 10, lines.length)).join(' ');
                        const pMatch = sectionText.match(/(?:principal|pencial|prncoat)[:\s]+\$?([\d,]+\.[\d]{2})/i);
                        const iMatch = sectionText.match(/interest[:\s]+\$?([\d,]+\.[\d]{2})/i);
                        
                        if (pMatch && iMatch) {
                            const p = parseFloat(pMatch[1].replace(/,/g, ''));
                            const i = parseFloat(iMatch[1].replace(/,/g, ''));
                            
                            if (p > 0 && i > 0 && p < 10000 && i < 10000) {
                                parsed.currentPrincipalPayment = p;
                                parsed.currentInterestPayment = i;
                                console.log(`Found payments (explanation section) - Principal: $${p}, Interest: $${i}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // Fallback: Just find Interest amount and look for nearby principal payment
            if (!parsed.currentInterestPayment) {
                const interestMatch = originalText.match(/interest[:\s]+\$\s*([\d,]+\.[\d]{2})/i);
                if (interestMatch) {
                    parsed.currentInterestPayment = parseFloat(interestMatch[1].replace(/,/g, ''));
                    console.log(`Found interest (simple match): $${parsed.currentInterestPayment}`);
                    
                    // Now look for a dollar amount before "Interest" in reasonable PAYMENT range
                    // Payments are typically $500-$5000, not $5k+ (that's escrow balance)
                    const beforeInterest = originalText.substring(Math.max(0, originalText.indexOf('Interest') - 200), originalText.indexOf('Interest'));
                    const amounts = beforeInterest.match(/\$\s*([\d,]+\.[\d]{2})/g);
                    if (amounts && amounts.length > 0) {
                        // Look for amounts in typical PAYMENT range ($100-$5000)
                        for (let i = amounts.length - 1; i >= 0; i--) {
                            const value = parseFloat(amounts[i].replace(/[$,\s]/g, ''));
                            if (value > 100 && value < 5000 && value !== parsed.currentInterestPayment) {
                                parsed.currentPrincipalPayment = value;
                                console.log(`Found principal payment (before interest, payment range): $${value}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // Log final parsed results
            console.log('Parsing complete:', {
                principal: parsed.principal || 'NOT FOUND',
                rate: parsed.rate || 'NOT FOUND',
                escrow: parsed.escrow || 'NOT FOUND',
                currentPrincipalPayment: parsed.currentPrincipalPayment || 'NOT FOUND',
                currentInterestPayment: parsed.currentInterestPayment || 'NOT FOUND'
            });
            
            return parsed;
        }

        function calculateMortgage() {
            const principal = parseFloat(document.getElementById('principal').value);
            const rate = parseFloat(document.getElementById('rate').value) / 100 / 12;
            let years = parseFloat(document.getElementById('years').value);
            const originalYears = parseFloat(document.getElementById('original-years').value) || null;
            const escrow = parseFloat(document.getElementById('escrow').value) || 0;
            let extra = parseFloat(document.getElementById('extra').value) || 0;
            const lumpsum = parseFloat(document.getElementById('lumpsum').value) || 0;
            const currentPrincipalPayment = parseFloat(document.getElementById('current-principal').value) || null;
            const currentInterestPayment = parseFloat(document.getElementById('current-interest').value) || null;
            
            if (!principal || !rate) {
                alert('Please fill in at least principal balance and interest rate.');
                return;
            }
            
            // If user provided current payment breakdown, calculate remaining term and detect extra payment
            if (currentPrincipalPayment && currentInterestPayment) {
                const totalPayment = currentPrincipalPayment + currentInterestPayment;
                
                // Calculate expected interest based on current balance
                const expectedInterest = principal * rate;
                const standardPrincipal = totalPayment - expectedInterest;
                
                // Detect extra payment
                if (currentPrincipalPayment > standardPrincipal + 50) {
                    extra = Math.round(currentPrincipalPayment - standardPrincipal);
                    document.getElementById('extra').value = extra;
                    console.log('Auto-detected extra payment:', extra);
                }
                
                // Calculate remaining term using standard payment
                const standardPayment = totalPayment - extra;
                years = calculateRemainingTerm(principal, rate, standardPayment) / 12;
                document.getElementById('years').value = years.toFixed(1);
                console.log('Auto-calculated remaining term:', years, 'years');
            }
            
            if (!years) {
                alert('Please fill in remaining term, or provide current payment breakdown to calculate it.');
                return;
            }
            
            // Calculate standard payment (without extra)
            const months = years * 12;
            const standardPayment = principal * (rate * Math.pow(1 + rate, months)) / (Math.pow(1 + rate, months) - 1);
            
            // Calculate standard schedule (for comparison)
            let standardBalance = principal;
            let standardTotalInterest = 0;
            for (let i = 0; i < months; i++) {
                const interest = standardBalance * rate;
                standardTotalInterest += interest;
                standardBalance -= (standardPayment - interest);
                if (standardBalance <= 0) break;
            }
            
            // Calculate prepayment schedule
            console.log('=== Prepayment Schedule Calculation ===');
            console.log('Standard payment:', standardPayment.toFixed(2));
            console.log('Extra payment:', extra.toFixed(2));
            console.log('Lump sum:', lumpsum.toFixed(2));
            console.log('Total monthly payment:', (standardPayment + extra + escrow).toFixed(2));
            
            scheduleData = [];
            let balance = principal;
            let totalInterest = 0;
            let totalPrincipal = 0;
            let month = 0;
            const today = new Date();
            
            while (balance > 0 && month < months) {
                const interest = balance * rate;
                let principalPayment = standardPayment - interest;
                let extraPayment = extra;
                
                // Apply lump sum on first month
                if (month === 0 && lumpsum > 0) {
                    extraPayment += lumpsum;
                }
                
                // Don't overpay
                if (principalPayment + extraPayment > balance) {
                    extraPayment = balance - principalPayment;
                    if (extraPayment < 0) extraPayment = 0;
                }
                
                balance -= (principalPayment + extraPayment);
                totalInterest += interest;
                totalPrincipal += principalPayment + extraPayment;
                
                const date = new Date(today);
                date.setMonth(date.getMonth() + month + 1);
                
                scheduleData.push({
                    month: month + 1,
                    date: date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                    payment: standardPayment + escrow,
                    principal: principalPayment,
                    interest: interest,
                    extra: extraPayment,
                    balance: Math.max(0, balance)
                });
                
                month++;
            }
            
            console.log('Schedule complete:', {
                months: month,
                totalInterest: totalInterest.toFixed(2),
                totalPrincipal: totalPrincipal.toFixed(2)
            });
            
            // Display summary
            const finalDate = scheduleData[scheduleData.length - 1].date;
            const yearsSaved = ((months - month) / 12).toFixed(1);
            const interestSaved = standardTotalInterest - totalInterest;
            const totalPaid = principal + totalInterest;
            
            document.getElementById('payoff-date').textContent = finalDate;
            document.getElementById('time-saved').textContent = `${yearsSaved} years earlier`;
            document.getElementById('interest-saved').textContent = '$' + interestSaved.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('total-paid').textContent = '$' + totalPaid.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Calculate loan progress if original term was provided
            if (originalYears) {
                const originalTermMonths = originalYears * 12;
                const remainingMonths = years * 12;
                
                // Calculate what the original loan amount would be
                const factor = Math.pow(1 + rate, originalTermMonths);
                const originalAmount = standardPayment * (factor - 1) / (rate * factor);
                
                const paymentsMade = originalTermMonths - remainingMonths;
                const principalPaid = originalAmount - principal;
                
                // Show loan progress
                document.getElementById('loan-progress').classList.remove('hidden');
                document.getElementById('original-amount').textContent = '$' + Math.round(originalAmount).toLocaleString();
                document.getElementById('original-term').textContent = originalYears + ' years';
                document.getElementById('payments-made').textContent = paymentsMade + ' months';
                document.getElementById('principal-paid').textContent = '$' + Math.round(principalPaid).toLocaleString();
            } else {
                document.getElementById('loan-progress').classList.add('hidden');
            }
            
            // Render table
            renderScheduleTable();
            
            // Render chart
            renderChart();
            
            // Show results
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function renderScheduleTable() {
            const tbody = document.getElementById('schedule-table');
            const infoDiv = document.getElementById('schedule-info');
            tbody.innerHTML = '';
            
            const view = document.getElementById('schedule-view').value;
            const maxRows = view === 'all' ? scheduleData.length : parseInt(view);
            const dataToShow = scheduleData.slice(0, maxRows);
            
            dataToShow.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-2 px-3 font-medium">${row.month}</td>
                    <td class="py-2 px-3">${row.date}</td>
                    <td class="py-2 px-3">$${row.payment.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="py-2 px-3">$${row.principal.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="py-2 px-3">$${row.interest.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="py-2 px-3 ${row.extra > 0 ? 'text-green-600 font-semibold' : ''}">$${row.extra.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="py-2 px-3 font-semibold">$${row.balance.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show info about what's displayed
            if (view !== 'all') {
                infoDiv.textContent = `Showing first ${maxRows} months of ${scheduleData.length} total. Use dropdown or export CSV for complete schedule.`;
            } else {
                infoDiv.textContent = `Showing all ${scheduleData.length} months.`;
            }
        }

        function renderChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            if (chart) chart.destroy();
            
            // Sample every 12 months for cleaner chart
            const sampledData = scheduleData.filter((row, i) => i % 12 === 0 || i === scheduleData.length - 1);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampledData.map(row => row.date),
                    datasets: [{
                        label: 'Remaining Balance',
                        data: sampledData.map(row => row.balance),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Balance: $' + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportToCSV() {
            let csv = 'Month,Date,Payment,Principal,Interest,Extra,Balance\n';
            
            scheduleData.forEach(row => {
                csv += `${row.month},${row.date},${row.payment.toFixed(2)},${row.principal.toFixed(2)},${row.interest.toFixed(2)},${row.extra.toFixed(2)},${row.balance.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mortgage-schedule-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
